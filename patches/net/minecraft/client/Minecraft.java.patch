--- a/net/minecraft/client/Minecraft.java
+++ b/net/minecraft/client/Minecraft.java
@@ -9,6 +9,8 @@
 import java.awt.Graphics;
 import java.io.File;
 import java.io.IOException;
+import java.lang.reflect.InvocationTargetException;
+import java.lang.reflect.Method;
 import java.nio.ByteBuffer;
 import java.text.DecimalFormat;
 import java.util.ArrayList;
@@ -16,105 +18,12 @@
 import java.util.Iterator;
 import java.util.List;
 import javax.swing.JPanel;
-import net.minecraft.src.AchievementList;
-import net.minecraft.src.AnvilSaveConverter;
-import net.minecraft.src.AxisAlignedBB;
-import net.minecraft.src.Block;
-import net.minecraft.src.CallableClientMemoryStats;
-import net.minecraft.src.CallableClientProfiler;
-import net.minecraft.src.CallableGLInfo;
-import net.minecraft.src.CallableLWJGLVersion;
-import net.minecraft.src.CallableModded;
-import net.minecraft.src.CallableParticleScreenName;
-import net.minecraft.src.CallableTexturePack;
-import net.minecraft.src.CallableTickingScreenName;
-import net.minecraft.src.CallableType2;
-import net.minecraft.src.CallableUpdatingScreenName;
-import net.minecraft.src.ColorizerFoliage;
-import net.minecraft.src.ColorizerGrass;
-import net.minecraft.src.CrashReport;
-import net.minecraft.src.CrashReportCategory;
-import net.minecraft.src.EffectRenderer;
-import net.minecraft.src.EntityBoat;
-import net.minecraft.src.EntityClientPlayerMP;
-import net.minecraft.src.EntityItemFrame;
-import net.minecraft.src.EntityList;
-import net.minecraft.src.EntityLiving;
-import net.minecraft.src.EntityMinecart;
-import net.minecraft.src.EntityPainting;
-import net.minecraft.src.EntityRenderer;
-import net.minecraft.src.EnumMovingObjectType;
-import net.minecraft.src.EnumOS;
-import net.minecraft.src.EnumOSHelper;
-import net.minecraft.src.EnumOptions;
-import net.minecraft.src.FontRenderer;
-import net.minecraft.src.GLAllocation;
-import net.minecraft.src.GameSettings;
-import net.minecraft.src.GameWindowListener;
-import net.minecraft.src.GuiAchievement;
-import net.minecraft.src.GuiChat;
-import net.minecraft.src.GuiConnecting;
-import net.minecraft.src.GuiGameOver;
-import net.minecraft.src.GuiIngame;
-import net.minecraft.src.GuiIngameMenu;
-import net.minecraft.src.GuiInventory;
-import net.minecraft.src.GuiMainMenu;
-import net.minecraft.src.GuiMemoryErrorScreen;
-import net.minecraft.src.GuiScreen;
-import net.minecraft.src.GuiSleepMP;
-import net.minecraft.src.HttpUtil;
-import net.minecraft.src.ILogAgent;
-import net.minecraft.src.INetworkManager;
-import net.minecraft.src.IPlayerUsage;
-import net.minecraft.src.ISaveFormat;
-import net.minecraft.src.ISaveHandler;
-import net.minecraft.src.IntegratedServer;
-import net.minecraft.src.Item;
-import net.minecraft.src.ItemRenderer;
-import net.minecraft.src.ItemStack;
-import net.minecraft.src.KeyBinding;
-import net.minecraft.src.LoadingScreenRenderer;
-import net.minecraft.src.LogAgent;
-import net.minecraft.src.MathHelper;
-import net.minecraft.src.MemoryConnection;
-import net.minecraft.src.MinecraftError;
-import net.minecraft.src.MinecraftFakeLauncher;
-import net.minecraft.src.MouseHelper;
-import net.minecraft.src.MovementInputFromOptions;
-import net.minecraft.src.MovingObjectPosition;
-import net.minecraft.src.NetClientHandler;
-import net.minecraft.src.OpenGlHelper;
-import net.minecraft.src.Packet3Chat;
-import net.minecraft.src.PlayerControllerMP;
-import net.minecraft.src.PlayerUsageSnooper;
-import net.minecraft.src.Profiler;
-import net.minecraft.src.ProfilerResult;
-import net.minecraft.src.RenderBlocks;
-import net.minecraft.src.RenderEngine;
-import net.minecraft.src.RenderGlobal;
-import net.minecraft.src.RenderManager;
-import net.minecraft.src.ReportedException;
-import net.minecraft.src.ScaledResolution;
-import net.minecraft.src.ScreenShotHelper;
-import net.minecraft.src.ServerData;
-import net.minecraft.src.Session;
-import net.minecraft.src.SoundManager;
-import net.minecraft.src.StatCollector;
-import net.minecraft.src.StatFileWriter;
-import net.minecraft.src.StatList;
-import net.minecraft.src.StatStringFormatKeyInv;
-import net.minecraft.src.StringTranslate;
-import net.minecraft.src.Tessellator;
-import net.minecraft.src.TextureManager;
-import net.minecraft.src.TexturePackList;
-import net.minecraft.src.ThreadClientSleep;
-import net.minecraft.src.ThreadDownloadResources;
-import net.minecraft.src.ThreadShutdown;
-import net.minecraft.src.Timer;
-import net.minecraft.src.WorldClient;
-import net.minecraft.src.WorldInfo;
-import net.minecraft.src.WorldRenderer;
-import net.minecraft.src.WorldSettings;
+
+import de.fruitfly.ovr.OculusRift;
+import de.fruitfly.ovr.IOculusRift;
+
+import net.minecraft.src.*;
+
 import org.lwjgl.LWJGLException;
 import org.lwjgl.Sys;
 import org.lwjgl.input.Keyboard;
@@ -127,6 +36,10 @@
 import org.lwjgl.opengl.GLContext;
 import org.lwjgl.opengl.PixelFormat;
 import org.lwjgl.util.glu.GLU;
+import com.mtbs3d.minecrift.VRRenderer;
+import cpw.mods.fml.relauncher.ArgsWrapper;
+import cpw.mods.fml.relauncher.Side;
+
 
 public abstract class Minecraft implements Runnable, IPlayerUsage
 {
@@ -145,8 +58,13 @@
 
     /** Instance of CrashReport. */
     private CrashReport crashReporter;
+    
+    /* Modified to fit in VR view */ 
     public int displayWidth;
     public int displayHeight;
+    
+    /* Actual size of the display buffer */
+    public int displayWidthVRFull;
     private Timer timer = new Timer(20.0F);
 
     /** Instance of PlayerUsageSnooper. */
@@ -183,6 +101,7 @@
     public GuiScreen currentScreen = null;
     public LoadingScreenRenderer loadingScreen;
     public EntityRenderer entityRenderer;
+    public VRRenderer vrRenderer;
 
     /** Reference to the download resources thread. */
     private ThreadDownloadResources downloadResourcesThread;
@@ -226,7 +145,7 @@
      * This is set to fpsCounter every debug screen update, and is shown on the debug screen. It's also sent as part of
      * the usage snooping.
      */
-    private static int debugFPS;
+    public static int debugFPS;
 
     /**
      * When you place a block, it's set to 6, decremented once per tick, when it's 0, you can place another block.
@@ -285,6 +204,10 @@
     /** Profiler currently displayed in the debug screen pie chart */
     private String debugProfilerName = "root";
 
+    /** Oculus Rift */
+    public IOculusRift oculusRift;
+	private int scaleFactor = 2;
+
     public Minecraft(Canvas par1Canvas, MinecraftApplet par2MinecraftApplet, int par3, int par4, boolean par5)
     {
         StatList.nopInit();
@@ -294,7 +217,8 @@
         Packet3Chat.maxChatLength = 32767;
         this.startTimerHackThread();
         this.mcCanvas = par1Canvas;
-        this.displayWidth = par3;
+        this.displayWidthVRFull = par3;
+        this.displayWidth = par3/2;
         this.displayHeight = par4;
         this.fullscreen = par5;
         theMinecraft = this;
@@ -344,7 +268,7 @@
             if (var1 != null)
             {
                 var1.setColor(Color.BLACK);
-                var1.fillRect(0, 0, this.displayWidth, this.displayHeight);
+                var1.fillRect(0, 0, this.displayWidthVRFull, this.displayHeight);
                 var1.dispose();
             }
 
@@ -353,22 +277,23 @@
         else if (this.fullscreen)
         {
             Display.setFullscreen(true);
-            this.displayWidth = Display.getDisplayMode().getWidth();
+            this.displayWidthVRFull = Display.getDisplayMode().getWidth();
             this.displayHeight = Display.getDisplayMode().getHeight();
 
-            if (this.displayWidth <= 0)
+            if (this.displayWidthVRFull <= 0)
             {
-                this.displayWidth = 1;
+                this.displayWidthVRFull = 1;
             }
 
             if (this.displayHeight <= 0)
             {
                 this.displayHeight = 1;
             }
+            this.displayWidth = this.displayWidth/2;
         }
         else
         {
-            Display.setDisplayMode(new DisplayMode(this.displayWidth, this.displayHeight));
+            Display.setDisplayMode(new DisplayMode(this.displayWidthVRFull, this.displayHeight));
         }
 
         Display.setTitle("Minecraft Minecraft 1.5.2");
@@ -403,6 +328,17 @@
         this.loadScreen();
         this.fontRenderer = new FontRenderer(this.gameSettings, "/font/default.png", this.renderEngine, false);
         this.standardGalacticFontRenderer = new FontRenderer(this.gameSettings, "/font/alternate.png", this.renderEngine, false);
+        
+        Object fmlClientHandler = null;
+        if( Reflector.FMLClientHandler_instance.exists())
+        {
+        	fmlClientHandler = Reflector.call( Reflector.FMLClientHandler_instance, new Object[0]);
+        }
+        
+        if( fmlClientHandler != null)
+        {
+        	Reflector.callVoid(fmlClientHandler, Reflector.FMLClientHandler_beginMinecraftLoading, new Object[]{this});
+        }
 
         if (this.gameSettings.language != null)
         {
@@ -413,7 +349,32 @@
 
         ColorizerGrass.setGrassBiomeColorizer(this.renderEngine.getTextureContents("/misc/grasscolor.png"));
         ColorizerFoliage.setFoliageBiomeColorizer(this.renderEngine.getTextureContents("/misc/foliagecolor.png"));
-        this.entityRenderer = new EntityRenderer(this);
+        if( gameSettings.useVR )
+        {
+        	
+            try {
+            	if( gameSettings.vrImplementation.equals("de.fruitfly.ovr.OculusRift"))
+            	{
+            		OculusRift.LoadLibrary(new File(new File(getMinecraftDir(),"bin"),"natives"));
+            	}
+
+    			oculusRift = (IOculusRift)Class.forName(gameSettings.vrImplementation).getConstructor().newInstance();
+    		} catch (Exception e) {
+    			//Yes, I am a bad person for catching Exception, sue me.
+    			e.printStackTrace();
+    		} 
+        	this.vrRenderer = new VRRenderer(this,oculusRift,guiAchievement);
+        	this.entityRenderer = this.vrRenderer;
+
+	        // Oculus init
+	        this.oculusRift.init();
+	        this.oculusRift.setIPD(this.gameSettings.ipd);
+
+        }
+        else
+        {
+        	this.entityRenderer = new EntityRenderer(this);
+        }
         RenderManager.instance.itemRenderer = new ItemRenderer(this);
         this.statFileWriter = new StatFileWriter(this.session, this.mcDataDir);
         AchievementList.openInventory.setStatStringFormatter(new StatStringFormatKeyInv(this));
@@ -436,8 +397,14 @@
         this.sndManager.loadSoundSettings(this.gameSettings);
         this.renderGlobal = new RenderGlobal(this, this.renderEngine);
         this.renderEngine.refreshTextureMaps();
-        GL11.glViewport(0, 0, this.displayWidth, this.displayHeight);
+        GL11.glViewport(0, 0, this.displayWidthVRFull, this.displayHeight);
         this.effectRenderer = new EffectRenderer(this.theWorld, this.renderEngine);
+        
+        if( fmlClientHandler != null )
+        {
+        	Reflector.callVoid(fmlClientHandler, Reflector.FMLClientHandler_finishMinecraftLoading, new Object[0]);
+        }
+        	
 
         try
         {
@@ -450,7 +417,25 @@
         }
 
         this.checkGLError("Post startup");
-        this.ingameGUI = new GuiIngame(this);
+        if( Reflector.ForgeGuiIngame.exists())
+        {
+        	try {
+				this.ingameGUI = (GuiIngame)Reflector.ForgeGuiIngame_Constructor.getTargetConstructor().newInstance(new Object[]{this});
+			} catch (IllegalArgumentException e) {
+				e.printStackTrace();
+			} catch (InstantiationException e) {
+				e.printStackTrace();
+			} catch (IllegalAccessException e) {
+				e.printStackTrace();
+			} catch (InvocationTargetException e) {
+				e.printStackTrace();
+			}
+        }
+        else
+        {
+        	this.ingameGUI = new GuiIngame(this);
+        }
+
 
         if (this.serverName != null)
         {
@@ -467,6 +452,11 @@
         {
             this.toggleFullscreen();
         }
+        
+        if( fmlClientHandler != null )
+        {
+    		Reflector.callVoid(fmlClientHandler, Reflector.FMLClientHandler_onInitializationComplete, new Object[0]);
+        }
     }
 
     /**
@@ -628,21 +618,29 @@
         {
             this.setIngameNotInFocus();
             ScaledResolution var2 = new ScaledResolution(this.gameSettings, this.displayWidth, this.displayHeight);
-            int var3 = var2.getScaledWidth();
-            int var4 = var2.getScaledHeight();
-            ((GuiScreen)par1GuiScreen).setWorldAndResolution(this, var3, var4);
+            int width = var2.getScaledWidth();
+            int height = var2.getScaledHeight();
+            scaleFactor = var2.scaleFactor;
+            ((GuiScreen)par1GuiScreen).setWorldAndResolution(this, width, height);
             this.skipRenderWorld = false;
+
         }
         else
         {
             this.setIngameFocus();
         }
+
+        if ((par1GuiScreen instanceof GuiMainMenu && this.theWorld == null)      ||
+            (par1GuiScreen instanceof GuiDisconnected && this.theWorld == null))
+        {
+            this.setIngameNotInFocus();        // TODO: Ensure disconnected menu has mouse pointer!
+        }
     }
 
     /**
      * Checks for an OpenGL error. If there is one, prints the error ID and error string.
      */
-    private void checkGLError(String par1Str)
+    public void checkGLError(String par1Str)
     {
         int var2 = GL11.glGetError();
 
@@ -700,6 +698,12 @@
             this.sndManager.closeMinecraft();
             Mouse.destroy();
             Keyboard.destroy();
+
+            if( this.oculusRift != null )
+            {
+	            // De-init Oculus
+	            this.oculusRift.destroy();
+            }
         }
         finally
         {
@@ -856,9 +860,26 @@
 
             if (!this.skipRenderWorld)
             {
+		    	Object fmlCommonHandler = null;
+		    	if( Reflector.FMLCommonHandler_instance.exists())
+		    	{
+		    		fmlCommonHandler = Reflector.call(Reflector.FMLCommonHandler_instance, new Object[0]);
+		    	}
+		    	if( fmlCommonHandler != null )
+		    	{
+		    		Reflector.callVoid(fmlCommonHandler, Reflector.FMLCommonHandler_onRenderTickStart, new Object[]{this.timer.renderPartialTicks});
+		    	}
                 this.mcProfiler.endStartSection("gameRenderer");
+	            int mouseX = Mouse.getX();
+	            int mouseY = Mouse.getY();
+	            Mouse.setCursorPosition(mouseX - this.displayWidth*scaleFactor/2, mouseY);
                 this.entityRenderer.updateCameraAndRender(this.timer.renderPartialTicks);
+                Mouse.setCursorPosition(mouseX, mouseY);
                 this.mcProfiler.endSection();
+		    	if( fmlCommonHandler != null )
+		    	{
+		    		Reflector.callVoid(fmlCommonHandler, Reflector.FMLCommonHandler_onRenderTickEnd, new Object[]{this.timer.renderPartialTicks});
+		    	}
             }
 
             GL11.glFlush();
@@ -869,7 +890,7 @@
                 this.toggleFullscreen();
             }
 
-            if (this.gameSettings.showDebugInfo && this.gameSettings.showDebugProfilerChart)
+            if (this.gameSettings.showDebugInfo  && this.gameSettings.showDebugProfilerChart)
             {
                 if (!this.mcProfiler.profilingEnabled)
                 {
@@ -885,7 +906,7 @@
                 this.prevFrameTime = System.nanoTime();
             }
 
-            this.guiAchievement.updateAchievementWindow();
+            //this.guiAchievement.updateAchievementWindow();
             this.mcProfiler.startSection("root");
             Thread.yield();
 
@@ -896,20 +917,21 @@
 
             this.screenshotListener();
 
-            if (this.mcCanvas != null && !this.fullscreen && (this.mcCanvas.getWidth() != this.displayWidth || this.mcCanvas.getHeight() != this.displayHeight))
+            if (this.mcCanvas != null && !this.fullscreen && (this.mcCanvas.getWidth() != this.displayWidthVRFull || this.mcCanvas.getHeight() != this.displayHeight))
             {
-                this.displayWidth = this.mcCanvas.getWidth();
+                this.displayWidthVRFull = this.mcCanvas.getWidth();
                 this.displayHeight = this.mcCanvas.getHeight();
 
-                if (this.displayWidth <= 0)
+                if (this.displayWidthVRFull <= 0)
                 {
-                    this.displayWidth = 1;
+                    this.displayWidthVRFull = 1;
                 }
 
                 if (this.displayHeight <= 0)
                 {
                     this.displayHeight = 1;
                 }
+                displayWidth = displayWidthVRFull/2;
 
                 this.resize(this.displayWidth, this.displayHeight);
             }
@@ -1192,12 +1214,11 @@
      */
     public void setIngameNotInFocus()
     {
-        if (this.inGameHasFocus)
-        {
-            KeyBinding.unPressAllKeys();
-            this.inGameHasFocus = false;
-            this.mouseHelper.ungrabMouseCursor();
-        }
+        KeyBinding.unPressAllKeys();
+        this.inGameHasFocus = false;
+        this.mouseHelper.grabMouseCursor();
+        //if( !gameSettings.useVR || this.theWorld == null ) //If we're in a world with the oculus, we're rendering in stereo, so keep mouse grabbed
+        //    this.mouseHelper.ungrabMouseCursor();
     }
 
     /**
@@ -1346,12 +1367,12 @@
             if (this.fullscreen)
             {
                 Display.setDisplayMode(Display.getDesktopDisplayMode());
-                this.displayWidth = Display.getDisplayMode().getWidth();
+                this.displayWidthVRFull = Display.getDisplayMode().getWidth();
                 this.displayHeight = Display.getDisplayMode().getHeight();
 
-                if (this.displayWidth <= 0)
+                if (this.displayWidthVRFull <= 0)
                 {
-                    this.displayWidth = 1;
+                    this.displayWidthVRFull = 1;
                 }
 
                 if (this.displayHeight <= 0)
@@ -1363,18 +1384,18 @@
             {
                 if (this.mcCanvas != null)
                 {
-                    this.displayWidth = this.mcCanvas.getWidth();
+                    this.displayWidthVRFull = this.mcCanvas.getWidth();
                     this.displayHeight = this.mcCanvas.getHeight();
                 }
                 else
                 {
-                    this.displayWidth = this.tempDisplayWidth;
+                    this.displayWidthVRFull = this.tempDisplayWidth;
                     this.displayHeight = this.tempDisplayHeight;
                 }
 
-                if (this.displayWidth <= 0)
+                if (this.displayWidthVRFull <= 0)
                 {
-                    this.displayWidth = 1;
+                    this.displayWidthVRFull = 1;
                 }
 
                 if (this.displayHeight <= 0)
@@ -1382,6 +1403,8 @@
                     this.displayHeight = 1;
                 }
             }
+            
+            this.displayWidth = displayWidthVRFull/2;
 
             if (this.currentScreen != null)
             {
@@ -1411,6 +1434,7 @@
             ScaledResolution var3 = new ScaledResolution(this.gameSettings, par1, par2);
             int var4 = var3.getScaledWidth();
             int var5 = var3.getScaledHeight();
+            this.scaleFactor = var3.scaleFactor;
             this.currentScreen.setWorldAndResolution(this, var4, var5);
         }
     }
@@ -1420,10 +1444,23 @@
      */
     public void runTick()
     {
+    	Object fmlCommonHandler = null;
+    	if( Reflector.FMLCommonHandler_instance.exists())
+    	{
+    		fmlCommonHandler = Reflector.call(Reflector.FMLCommonHandler_instance, new Object[0]);
+    	}
+    	if( fmlCommonHandler != null )
+    	{
+    		Reflector.callVoid(fmlCommonHandler, Reflector.FMLCommonHandler_rescheduleTicks, new Object[]{Side.CLIENT});
+    	}
         if (this.rightClickDelayTimer > 0)
         {
             --this.rightClickDelayTimer;
         }
+    	if( fmlCommonHandler != null )
+    	{
+    		Reflector.callVoid(fmlCommonHandler, Reflector.FMLCommonHandler_onPreClientTick, new Object[0]);
+    	}
 
         this.mcProfiler.startSection("stats");
         this.statFileWriter.func_77449_e();
@@ -1451,21 +1488,24 @@
             this.renderEngine.updateDynamicTextures();
         }
 
-        if (this.currentScreen == null && this.thePlayer != null)
+        if (this.theWorld == null)    // TODO: Only display if world null - otherwise display in render
         {
-            if (this.thePlayer.getHealth() <= 0)
+            if (this.currentScreen == null && this.thePlayer != null)
             {
-                this.displayGuiScreen((GuiScreen)null);
+                if (this.thePlayer.getHealth() <= 0)
+                {
+                    this.displayGuiScreen((GuiScreen)null);
+                }
+                else if (this.thePlayer.isPlayerSleeping() && this.theWorld != null)
+                {
+                    this.displayGuiScreen(new GuiSleepMP());
+                }
             }
-            else if (this.thePlayer.isPlayerSleeping() && this.theWorld != null)
+            else if (this.currentScreen != null && this.currentScreen instanceof GuiSleepMP && !this.thePlayer.isPlayerSleeping())
             {
-                this.displayGuiScreen(new GuiSleepMP());
+                this.displayGuiScreen((GuiScreen)null);
             }
         }
-        else if (this.currentScreen != null && this.currentScreen instanceof GuiSleepMP && !this.thePlayer.isPlayerSleeping())
-        {
-            this.displayGuiScreen((GuiScreen)null);
-        }
 
         if (this.currentScreen != null)
         {
@@ -1565,7 +1605,7 @@
                     }
                     else if (this.currentScreen != null)
                     {
-                        this.currentScreen.handleMouseInput();
+                        this.currentScreen.handleInput();
                     }
                 }
             }
@@ -1623,6 +1663,209 @@
                                 this.displayInGameMenu();
                             }
 
+                            if (gameSettings.useVR)
+                            {
+                                // TODO: Capture oculus key events
+
+                                //  Reinitialise head tracking
+                                if (Keyboard.getEventKey() == Keyboard.KEY_O && Keyboard.isKeyDown(Keyboard.KEY_LCONTROL))
+                                {
+                                    this.oculusRift.destroy();
+                                    this.oculusRift.init();
+                                    oculusRift.setIPD(this.gameSettings.ipd);
+                                }
+
+                                // Distortion on / off
+                                if (Keyboard.getEventKey() == Keyboard.KEY_P && Keyboard.isKeyDown(Keyboard.KEY_LCONTROL))
+                                {
+                                    // Chromatic ab correction
+                                    if (Keyboard.isKeyDown(Keyboard.KEY_LMENU))
+                                    {
+                                        this.gameSettings.useChromaticAbCorrection = !this.gameSettings.useChromaticAbCorrection;
+                                        this.gameSettings.saveOptions();
+                                        this.vrRenderer._FBOInitialised = false; // Reinit FBO and shaders
+                                    }
+                                    else
+                                    {
+                                        this.gameSettings.useDistortion = !this.gameSettings.useDistortion;
+                                    }
+                                }
+
+                                // Supersampling on/off
+                                if (Keyboard.getEventKey() == Keyboard.KEY_B && Keyboard.isKeyDown(Keyboard.KEY_LCONTROL))
+                                {
+                                    // FSAA on/off
+                                    if (Keyboard.isKeyDown(Keyboard.KEY_LMENU))
+                                    {
+                                        this.gameSettings.superSampleScaleFactor += 0.5f;
+                                        if (this.gameSettings.superSampleScaleFactor > 4.0f)
+                                        {
+                                            this.gameSettings.superSampleScaleFactor = 1.5f;
+                                        }
+                                        this.gameSettings.saveOptions();
+                                        this.vrRenderer._FBOInitialised = false;
+                                    }
+                                    else
+                                    {
+                                        this.gameSettings.useSupersample = !this.gameSettings.useSupersample;
+                                        this.gameSettings.saveOptions();
+                                        this.vrRenderer._FBOInitialised = false; // Reinit FBO and shaders
+                                    }
+                                }
+
+                                // Head tracking on / off
+                                if (Keyboard.getEventKey() == Keyboard.KEY_L && Keyboard.isKeyDown(Keyboard.KEY_LCONTROL))
+                                {
+                                    if (Keyboard.isKeyDown(Keyboard.KEY_LMENU))
+                                    {
+                                        this.gameSettings.useHeadTrackPrediction = !this.gameSettings.useHeadTrackPrediction;
+
+                                        if (this.gameSettings.useHeadTrackPrediction)
+                                            oculusRift.setPrediction(0.03f, true);
+                                        else
+                                            oculusRift.setPrediction(0.03f, false);
+
+                                        this.gameSettings.saveOptions();
+                                    }
+                                    else
+                                    {
+                                        this.gameSettings.useHeadTracking = !this.gameSettings.useHeadTracking;
+                                    }
+                                }
+
+                                // Lock distance
+                                if (Keyboard.getEventKey() == Keyboard.KEY_U && Keyboard.isKeyDown(Keyboard.KEY_LCONTROL))
+                                {
+                                    // HUD scale
+                                    if (Keyboard.isKeyDown(Keyboard.KEY_LMENU))
+                                    {
+                                        this.gameSettings.hudScale -= 0.01f;
+                                        if (this.gameSettings.hudScale < 0.15f)
+                                        {
+                                            this.gameSettings.hudScale = 1.25f;
+                                        }
+                                        this.gameSettings.saveOptions();
+                                    }
+                                    else
+                                    {
+                                        this.gameSettings.hudDistance -= 0.01f;
+                                        if (this.gameSettings.hudDistance < 0.15f)
+                                        {
+                                            this.gameSettings.hudDistance = 1.25f;
+                                        }
+                                        this.gameSettings.saveOptions();
+                                        //this.gameSettings.lockHud = !this.gameSettings.lockHud; // TOOD: HUD lock removed for now
+                                    }
+                                }
+
+                                // Hud opacity on / off
+                                if (Keyboard.getEventKey() == Keyboard.KEY_Y && Keyboard.isKeyDown(Keyboard.KEY_LCONTROL))
+                                {
+                                    gameSettings.useHudOpacity = !gameSettings.useHudOpacity;
+                                    this.gameSettings.saveOptions();
+                                }
+
+                                // Render headwear / ON/off
+                                if (Keyboard.getEventKey() == Keyboard.KEY_M && Keyboard.isKeyDown(Keyboard.KEY_LCONTROL))
+                                {
+                                    gameSettings.renderHeadWear = !gameSettings.renderHeadWear;
+                                    this.gameSettings.saveOptions();
+                                }
+
+                                // Allow mouse pitch
+                                if (Keyboard.getEventKey() == Keyboard.KEY_N && Keyboard.isKeyDown(Keyboard.KEY_LCONTROL))
+                                {
+                                    gameSettings.allowMousePitchInput = !gameSettings.allowMousePitchInput;
+                                    this.gameSettings.saveOptions();
+                                }
+
+                                // FOV+
+                                if (Keyboard.getEventKey() == Keyboard.KEY_PERIOD && Keyboard.isKeyDown(Keyboard.KEY_LCONTROL))
+                                {
+                                    if (Keyboard.isKeyDown(Keyboard.KEY_LMENU))
+                                    {
+                                        // Distortion fit point
+                                        gameSettings.distortionFitPoint += 1;
+                                        if (gameSettings.distortionFitPoint > 14)
+                                            gameSettings.distortionFitPoint = 14;
+                                        this.gameSettings.saveOptions();
+                                        this.vrRenderer._FBOInitialised = false; // Reinit FBO and shaders
+                                    }
+                                    else
+                                    {
+                                        // FOV
+                                        gameSettings.fovScaleFactor += 0.001f;
+                                        this.gameSettings.saveOptions();
+                                    }
+                                }
+
+                                // FOV-
+                                if (Keyboard.getEventKey() == Keyboard.KEY_COMMA && Keyboard.isKeyDown(Keyboard.KEY_LCONTROL))
+                                {
+                                    if (Keyboard.isKeyDown(Keyboard.KEY_LMENU))
+                                    {
+                                        // Distortion fit point
+                                        gameSettings.distortionFitPoint -= 1;
+                                        if (gameSettings.distortionFitPoint < 0)
+                                            gameSettings.distortionFitPoint = 0;
+                                        this.gameSettings.saveOptions();
+                                        this.vrRenderer._FBOInitialised = false; // Reinit FBO and shaders
+                                    }
+                                    else
+                                    {
+                                        // FOV
+                                        gameSettings.fovScaleFactor -= 0.001f;
+                                        this.gameSettings.saveOptions();
+                                    }
+                                }
+
+                                // Cycle head track sensitivity
+                                if (Keyboard.getEventKey() == Keyboard.KEY_V && Keyboard.isKeyDown(Keyboard.KEY_LCONTROL))
+                                {
+                                    this.gameSettings.headTrackSensitivity += 0.1f;
+                                    if (this.gameSettings.headTrackSensitivity > 4.05f)
+                                    {
+                                        this.gameSettings.headTrackSensitivity = 0.5f;
+                                    }
+                                    this.gameSettings.saveOptions();
+                                }
+
+                                // Increase IPD
+                                if (Keyboard.getEventKey() == Keyboard.KEY_EQUALS && Keyboard.isKeyDown(Keyboard.KEY_LCONTROL))
+                                {
+                                    float newIpd;
+                                    if (Keyboard.isKeyDown(Keyboard.KEY_LMENU))
+                                    {
+                                        newIpd = this.gameSettings.ipd + 0.0001f;
+                                    }
+                                    else
+                                    {
+                                        newIpd = this.gameSettings.ipd + 0.0005f;
+                                    }
+                                    oculusRift.setIPD(newIpd);
+                                    this.gameSettings.ipd = newIpd;
+                                    this.gameSettings.saveOptions();
+                                }
+
+                                // Decrease IPD
+                                if (Keyboard.getEventKey() == Keyboard.KEY_MINUS && Keyboard.isKeyDown(Keyboard.KEY_LCONTROL))
+                                {
+                                    float newIpd;
+                                    if (Keyboard.isKeyDown(Keyboard.KEY_LMENU))
+                                    {
+                                        newIpd = this.gameSettings.ipd - 0.0001f;
+                                    }
+                                    else
+                                    {
+                                        newIpd = this.gameSettings.ipd - 0.0005f;
+                                    }
+                                    oculusRift.setIPD(newIpd);
+                                    this.gameSettings.ipd = newIpd;
+                                    this.gameSettings.saveOptions();
+                                }
+                            }
+
+
                             if (Keyboard.getEventKey() == 31 && Keyboard.isKeyDown(61))
                             {
                                 this.forceReload();
@@ -1667,10 +1910,11 @@
                                 this.gameSettings.hideGUI = !this.gameSettings.hideGUI;
                             }
 
-                            if (Keyboard.getEventKey() == 61)
+                            if (Keyboard.getEventKey() == Keyboard.KEY_F3)
                             {
                                 this.gameSettings.showDebugInfo = !this.gameSettings.showDebugInfo;
                                 this.gameSettings.showDebugProfilerChart = GuiScreen.isShiftKeyDown();
+                                this.gameSettings.showOculusDebugInfo = GuiScreen.isCtrlKeyDown();
                             }
 
                             if (Keyboard.getEventKey() == 63)
@@ -1881,6 +2125,11 @@
             this.myNetworkManager.processReadPackets();
         }
 
+    	if( fmlCommonHandler != null )
+    	{
+    		Reflector.callVoid(fmlCommonHandler, Reflector.FMLCommonHandler_onPostClientTick, new Object[0]);
+    	}
+
         this.mcProfiler.endSection();
         this.systemTime = getSystemTime();
     }
@@ -1925,8 +2174,43 @@
         }
 
         this.statFileWriter.readStat(StatList.startGameStat, 1);
+        
+        boolean fmlGameData = Reflector.FMLGameData.exists();
+        if( fmlGameData )
+        {
+        	Reflector.callVoid(Reflector.FMLGameData_initializeServerGate, new Object[]{2});
+        }
+
+
         this.theIntegratedServer = new IntegratedServer(this, par1Str, par2Str, par3WorldSettings);
         this.theIntegratedServer.startServerThread();
+        
+        if( fmlGameData  )
+        {
+			Object idDifferences = Reflector.call(Reflector.FMLGameData_gateWorldLoadingForValidation, new Object[0]);
+			if( idDifferences == null )
+			{
+				System.out.println("idDiff == null, continueLoading");
+				Reflector.call(Reflector.FMLGameData_releaseGate, new Object[]{true});
+				continueWorldLoading();
+			}
+			else
+			{
+		        Object var1 = Reflector.call(Reflector.FMLClientHandler_instance, new Object[0]);
+		        Reflector.call( var1, Reflector.FMLClientHandler_warnIDMismatch, new Object[]{idDifferences, true });
+			}
+        	
+        }
+        else
+        {
+			System.out.println("fmlGameData == null , continueLoading");
+        	continueWorldLoading();
+        }
+    }
+
+    public void continueWorldLoading() 
+    {
+        
         this.integratedServerIsRunning = true;
         this.loadingScreen.displayProgressMessage(StatCollector.translateToLocal("menu.loadingLevel"));
 
@@ -1980,6 +2264,11 @@
     public void loadWorld(WorldClient par1WorldClient, String par2Str)
     {
         this.statFileWriter.syncStats();
+        
+        if (this.theWorld != null && Reflector.EventBus.exists())
+        {
+            Reflector.postForgeBusEvent(Reflector.WorldEvent_Unload_Constructor, new Object[] {this.theWorld});
+        }
 
         if (par1WorldClient == null)
         {
@@ -2021,6 +2310,7 @@
 
             this.setServerData((ServerData)null);
             this.integratedServerIsRunning = false;
+            this.setIngameNotInFocus();
         }
 
         this.sndManager.playStreaming((String)null, 0.0F, 0.0F, 0.0F);
@@ -2178,6 +2468,31 @@
 
     public static void main(String[] par0ArrayOfStr)
     {
+	    ReflectorClass FMLRelauncher = new ReflectorClass("cpw.mods.fml.relauncher.FMLRelauncher");
+	    ReflectorMethod FMLRelauncher_handleClientRelaunch = new ReflectorMethod(FMLRelauncher, "handleClientRelaunch");
+    	ArgsWrapper wrapper = new ArgsWrapper( par0ArrayOfStr );
+    	if( FMLRelauncher.exists() )
+    	{
+	        try
+	        {
+				Method var2 = FMLRelauncher_handleClientRelaunch.getTargetMethod();
+	            var2.invoke((Object)null, wrapper);
+	    		System.out.println("For rizzles Relaunching..");
+	        }
+	        catch (Throwable var3)
+	        {
+	    		System.out.println("Gah! Couldn't relaunch, FML is broken...");
+	    	}
+    	}
+    	else
+    	{
+    		fmlReentry( wrapper );
+    	}
+    }
+    
+    public static void fmlReentry(ArgsWrapper wrapper)
+    {
+    	String[] par0ArrayOfStr = wrapper.args;
         HashMap var1 = new HashMap();
         boolean var2 = false;
         boolean var3 = true;
@@ -2319,103 +2634,110 @@
         if (this.objectMouseOver != null)
         {
             boolean var1 = this.thePlayer.capabilities.isCreativeMode;
-            int var3 = 0;
-            boolean var4 = false;
-            int var2;
             int var5;
-
-            if (this.objectMouseOver.typeOfHit == EnumMovingObjectType.TILE)
-            {
-                var5 = this.objectMouseOver.blockX;
-                int var6 = this.objectMouseOver.blockY;
-                int var7 = this.objectMouseOver.blockZ;
-                Block var8 = Block.blocksList[this.theWorld.getBlockId(var5, var6, var7)];
-
-                if (var8 == null)
-                {
-                    return;
-                }
-
-                var2 = var8.idPicked(this.theWorld, var5, var6, var7);
-
-                if (var2 == 0)
-                {
-                    return;
-                }
-
-                var4 = Item.itemsList[var2].getHasSubtypes();
-                int var9 = var2 < 256 && !Block.blocksList[var8.blockID].isFlowerPot() ? var2 : var8.blockID;
-                var3 = Block.blocksList[var9].getDamageValue(this.theWorld, var5, var6, var7);
-            }
-            else
+            if(!Reflector.ForgeHooks_onPickBlock.exists())
             {
-                if (this.objectMouseOver.typeOfHit != EnumMovingObjectType.ENTITY || this.objectMouseOver.entityHit == null || !var1)
-                {
-                    return;
-                }
-
-                if (this.objectMouseOver.entityHit instanceof EntityPainting)
-                {
-                    var2 = Item.painting.itemID;
-                }
-                else if (this.objectMouseOver.entityHit instanceof EntityItemFrame)
-                {
-                    EntityItemFrame var10 = (EntityItemFrame)this.objectMouseOver.entityHit;
-
-                    if (var10.getDisplayedItem() == null)
-                    {
-                        var2 = Item.itemFrame.itemID;
-                    }
-                    else
-                    {
-                        var2 = var10.getDisplayedItem().itemID;
-                        var3 = var10.getDisplayedItem().getItemDamage();
-                        var4 = true;
-                    }
-                }
-                else if (this.objectMouseOver.entityHit instanceof EntityMinecart)
-                {
-                    EntityMinecart var11 = (EntityMinecart)this.objectMouseOver.entityHit;
-
-                    if (var11.getMinecartType() == 2)
-                    {
-                        var2 = Item.minecartPowered.itemID;
-                    }
-                    else if (var11.getMinecartType() == 1)
-                    {
-                        var2 = Item.minecartCrate.itemID;
-                    }
-                    else if (var11.getMinecartType() == 3)
-                    {
-                        var2 = Item.minecartTnt.itemID;
-                    }
-                    else if (var11.getMinecartType() == 5)
-                    {
-                        var2 = Item.minecartHopper.itemID;
-                    }
-                    else
-                    {
-                        var2 = Item.minecartEmpty.itemID;
-                    }
-                }
-                else if (this.objectMouseOver.entityHit instanceof EntityBoat)
-                {
-                    var2 = Item.boat.itemID;
-                }
-                else
-                {
-                    var2 = Item.monsterPlacer.itemID;
-                    var3 = EntityList.getEntityID(this.objectMouseOver.entityHit);
-                    var4 = true;
-
-                    if (var3 <= 0 || !EntityList.entityEggs.containsKey(Integer.valueOf(var3)))
-                    {
-                        return;
-                    }
-                }
-            }
-
-            this.thePlayer.inventory.setCurrentItem(var2, var3, var4, var1);
+	            int var3 = 0;
+	            boolean var4 = false;
+	            int var2;
+	
+	            if (this.objectMouseOver.typeOfHit == EnumMovingObjectType.TILE)
+	            {
+	                var5 = this.objectMouseOver.blockX;
+	                int var6 = this.objectMouseOver.blockY;
+	                int var7 = this.objectMouseOver.blockZ;
+	                Block var8 = Block.blocksList[this.theWorld.getBlockId(var5, var6, var7)];
+	
+	                if (var8 == null)
+	                {
+	                    return;
+	                }
+	
+	                var2 = var8.idPicked(this.theWorld, var5, var6, var7);
+	
+	                if (var2 == 0)
+	                {
+	                    return;
+	                }
+	
+	                var4 = Item.itemsList[var2].getHasSubtypes();
+	                int var9 = var2 < 256 && !Block.blocksList[var8.blockID].isFlowerPot() ? var2 : var8.blockID;
+	                var3 = Block.blocksList[var9].getDamageValue(this.theWorld, var5, var6, var7);
+	            }
+	            else
+	            {
+	                if (this.objectMouseOver.typeOfHit != EnumMovingObjectType.ENTITY || this.objectMouseOver.entityHit == null || !var1)
+	                {
+	                    return;
+	                }
+	
+	                if (this.objectMouseOver.entityHit instanceof EntityPainting)
+	                {
+	                    var2 = Item.painting.itemID;
+	                }
+	                else if (this.objectMouseOver.entityHit instanceof EntityItemFrame)
+	                {
+	                    EntityItemFrame var10 = (EntityItemFrame)this.objectMouseOver.entityHit;
+	
+	                    if (var10.getDisplayedItem() == null)
+	                    {
+	                        var2 = Item.itemFrame.itemID;
+	                    }
+	                    else
+	                    {
+	                        var2 = var10.getDisplayedItem().itemID;
+	                        var3 = var10.getDisplayedItem().getItemDamage();
+	                        var4 = true;
+	                    }
+	                }
+	                else if (this.objectMouseOver.entityHit instanceof EntityMinecart)
+	                {
+	                    EntityMinecart var11 = (EntityMinecart)this.objectMouseOver.entityHit;
+	
+	                    if (var11.getMinecartType() == 2)
+	                    {
+	                        var2 = Item.minecartPowered.itemID;
+	                    }
+	                    else if (var11.getMinecartType() == 1)
+	                    {
+	                        var2 = Item.minecartCrate.itemID;
+	                    }
+	                    else if (var11.getMinecartType() == 3)
+	                    {
+	                        var2 = Item.minecartTnt.itemID;
+	                    }
+	                    else if (var11.getMinecartType() == 5)
+	                    {
+	                        var2 = Item.minecartHopper.itemID;
+	                    }
+	                    else
+	                    {
+	                        var2 = Item.minecartEmpty.itemID;
+	                    }
+	                }
+	                else if (this.objectMouseOver.entityHit instanceof EntityBoat)
+	                {
+	                    var2 = Item.boat.itemID;
+	                }
+	                else
+	                {
+	                    var2 = Item.monsterPlacer.itemID;
+	                    var3 = EntityList.getEntityID(this.objectMouseOver.entityHit);
+	                    var4 = true;
+	
+	                    if (var3 <= 0 || !EntityList.entityEggs.containsKey(Integer.valueOf(var3)))
+	                    {
+	                        return;
+	                    }
+	                }
+	            }
+	
+	            this.thePlayer.inventory.setCurrentItem(var2, var3, var4, var1);
+	        }
+	        else if (!Reflector.callBoolean(Reflector.ForgeHooks_onPickBlock, new Object[]{this.objectMouseOver,this.thePlayer,this.theWorld}))
+	        {
+	        	return;
+	        }
 
             if (var1)
             {
@@ -2507,8 +2829,13 @@
     /**
      * Used in the usage snooper.
      */
+    private static int max_texture_size = -1;
     public static int getGLMaximumTextureSize()
     {
+    	if (max_texture_size != -1)
+    	{
+    		return max_texture_size;
+    	}
         for (int var0 = 16384; var0 > 0; var0 >>= 1)
         {
             GL11.glTexImage2D(GL11.GL_PROXY_TEXTURE_2D, 0, GL11.GL_RGBA, var0, var0, 0, GL11.GL_RGBA, GL11.GL_UNSIGNED_BYTE, (ByteBuffer)null);
@@ -2516,6 +2843,7 @@
 
             if (var1 != 0)
             {
+            	max_texture_size = var0;
                 return var0;
             }
         }
